<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Zookeeper学习笔记 | Wshape1's Blogs</title><meta name="keywords" content="笔记,Zookeeper"><meta name="author" content="Wshape1"><meta name="copyright" content="Wshape1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Zookeeper 观看千锋最新Zookeeper集群教程-全网最全Zookeeper应用及原理分析课程_哔哩哔哩_bilibili进行学习。 部分笔记来源于网络。 本文使用的Zookeeper版本是3.7.1   分布式协调组件     graph LR 	用户 &#x3D;&#x3D;&gt; Nginx 	--&gt; a[服务A-1&lt;br&#x2F;&gt;int flag&amp;#x3D">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookeeper学习笔记">
<meta property="og:url" content="https://wshape1.github.io/2023/02/21/zookeeper-note/index.html">
<meta property="og:site_name" content="Wshape1&#39;s Blogs">
<meta property="og:description" content="Zookeeper 观看千锋最新Zookeeper集群教程-全网最全Zookeeper应用及原理分析课程_哔哩哔哩_bilibili进行学习。 部分笔记来源于网络。 本文使用的Zookeeper版本是3.7.1   分布式协调组件     graph LR 	用户 &#x3D;&#x3D;&gt; Nginx 	--&gt; a[服务A-1&lt;br&#x2F;&gt;int flag&amp;#x3D">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zookeeper.apache.org/images/zookeeper_small.gif">
<meta property="article:published_time" content="2023-02-21T13:50:00.000Z">
<meta property="article:modified_time" content="2023-03-24T15:15:00.000Z">
<meta property="article:author" content="Wshape1">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="Zookeeper">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zookeeper.apache.org/images/zookeeper_small.gif"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://wshape1.github.io/2023/02/21/zookeeper-note/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6e08a4bb728f26f7e0f454d9872af9ac";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.json","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Zookeeper学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-24 23:15:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cache.yisu.com/upload/information/20220118/481/183040.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Wshape1's Blogs</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Zookeeper学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-21T13:50:00.000Z" title="发表于 2023-02-21 21:50:00">2023-02-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-24T15:15:00.000Z" title="更新于 2023-03-24 23:15:00">2023-03-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Redis/">Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>14分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Zookeeper学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h1><blockquote>
<p>观看<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ph411n7Ep/">千锋最新Zookeeper集群教程-全网最全Zookeeper应用及原理分析课程_哔哩哔哩_bilibili</a>进行学习。</p>
<p>部分笔记来源于网络。</p>
<p><strong>本文使用的Zookeeper版本是3.7.1</strong></p>
</blockquote>
<ul>
<li>分布式协调组件</li>
</ul>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  graph LR
	用户 &#x3D;&#x3D;&gt; Nginx
	--&gt; a[服务A-1&lt;br&#x2F;&gt;int flag&#x3D;true] --&gt; r
	b[服务A-2&lt;br&#x2F;&gt;int flag&#x3D;true] --&gt; r
	r[分布式协调中心Zookeeper&lt;br&gt;Znode节点:flag&#x3D;true&lt;br&gt;一旦节点发生改变,&lt;br&gt;就会通知所有监听改变自己的值-Watch机制&lt;br&gt;分布式锁可以让分布式服务处于无状态]
  </pre></div>
<p>在分布式系统中，需要有zookeeper作为分布式协调组件，协调分布式系统中的状态</p>
<ul>
<li>分布式锁</li>
</ul>
<p>zk在实现分布式锁上，可以做到强一致性，关于分布式锁的相关知识，会在之后的ZAB协议中介绍</p>
<ul>
<li>无状态化的实现</li>
</ul>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart TD
	客户端 --&gt; b
	a[分布式系统&lt;br&gt;登录系统] --保存登录信息--&gt; z
	b[分布式系统&lt;br&gt;登录系统] --&gt; z
	c[分布式系统&lt;br&gt;登录系统] --校验--&gt; z
	subgraph z[Zookeeper]
		登录信息
	end
  </pre></div>
<h2 id="安装和配置启动"><a href="#安装和配置启动" class="headerlink" title="安装和配置启动"></a>安装和配置启动</h2><h3 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h3><p>官网下载：<a target="_blank" rel="noopener" href="https://zookeeper.apache.org/releases.html">Apache ZooKeeper</a></p>
<p>阿里云镜像站下载：<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/apache/zookeeper/">apache-zookeeper安装包下载_开源镜像站-阿里云 (aliyun.com)</a></p>
<p>下载后解压即可。</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件样例<code>conf/zoo_sample.cfg</code>如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The number of milliseconds of each tick</span></span><br><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"># 允许follower初始化连接到leader最大时长，它表示tickTime时间倍数</span></span><br><span class="line"><span class="comment"># 即initLimit*tickTime</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># 允许follower与leader数据同步最大时长，它表示tickTime时间倍数</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="comment"># zookeeper数据（快照）储存的目录</span></span><br><span class="line"><span class="comment"># 若无dataLogDir则日志也储存在此目录</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">/tmp/zookeeper</span></span><br><span class="line"><span class="comment"># 对客户端提供的端口号</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"><span class="comment"># 客户端的最大连接数</span></span><br><span class="line"><span class="comment">#maxClientCnxns=60</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 保存的快照数量</span></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 自动触发清除任务时间间隔，单位小时</span></span><br><span class="line"><span class="comment"># 0表示关闭</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">## Metrics Providers</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://prometheus.io Metrics Exporter</span></span><br><span class="line"><span class="comment">#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider</span></span><br><span class="line"><span class="comment">#metricsProvider.httpPort=7000</span></span><br><span class="line"><span class="comment">#metricsProvider.exportJvmInfo=true</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>要启动必须要有一个配置文件，我们复制一份样例文件在相同目录并重命名为<code>zoo.cfg</code>，修改相关配置即可。</p>
<p><strong>zookeeper默认寻找conf/zoo.cfg配置文件。</strong></p>
<h3 id="启动Zookeeper"><a href="#启动Zookeeper" class="headerlink" title="启动Zookeeper"></a>启动Zookeeper</h3><p>在bin目录下可以看到许多可执行脚本，后缀为cmd为Windows下执行的，sh为Linux下执行的。</p>
<h4 id="Windows下启动"><a href="#Windows下启动" class="headerlink" title="Windows下启动"></a>Windows下启动</h4><p>双击<code>zkServer.cmd</code>打开，不闪退则启动成功。</p>
<p>双击<code>zkCli.cmd</code>打开客户端窗口。</p>
<h4 id="Linux下启动"><a href="#Linux下启动" class="headerlink" title="Linux下启动"></a>Linux下启动</h4><p>在bin目录下：</p>
<ul>
<li><code>./zkServer.sh start</code>启动Zookeeper</li>
<li><code>./zkServer.sh status</code>查询Zookeeper状态信息</li>
<li><code>./zkServer.sh stop</code>停止Zookeeper</li>
<li>在后面添加配置文件路径来指定配置文件<ul>
<li>如：<code>./zkServer.sh start ../conf/zoo.cfg</code></li>
</ul>
</li>
</ul>
<p>连接客户端：</p>
<ul>
<li><code>./zkCli.sh -server &lt;host:port&gt;</code>连接Zookeeper，没有-server默认连接localhost:2181</li>
</ul>
<h2 id="内部数据模型"><a href="#内部数据模型" class="headerlink" title="内部数据模型"></a>内部数据模型</h2><p>Zookeeper的数据是以<strong>节点(Znode)</strong>的形式构成一棵<strong>树</strong>储存。</p>
<p><code>/</code>为树的根。</p>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart TD
	&#x2F; --&gt; a --&gt; aa
	&#x2F; --&gt; b --&gt;ba
	a --&gt; ab
	b --&gt; bb
  </pre></div>
<h3 id="Znode的组成"><a href="#Znode的组成" class="headerlink" title="Znode的组成"></a>Znode的组成</h3><p>Zookeeper中的Znode包含了四个部分</p>
<p> data：保存数据</p>
<p> acl：权限：</p>
<ul>
<li><p>c：create 创建权限，允许在该节点下创建子节点</p>
</li>
<li><p>w：write 更新权限，允许更新该节点的数据</p>
</li>
<li><p>r：read 读取权限，允许读取该节点的内容以及子节点的列表信息</p>
</li>
<li><p>d：delete 删除权限，允许删除该节点的子节点信息</p>
</li>
<li><p>a：admin 管理者权限，允许对该节点进行acl权限设置</p>
<p>stat：描述当前znode的元数据</p>
<p>child：当前节点的子节点</p>
</li>
</ul>
<h3 id="Znode的类型"><a href="#Znode的类型" class="headerlink" title="Znode的类型"></a>Znode的类型</h3><ol>
<li><p><strong>持久节点</strong>：创建出的节点，在会话结束后依然存在。保存数据</p>
</li>
<li><p><strong>持久序号节点</strong>：创建出的节点，根据先后顺序，会在节点之后带上一个数值，越后执行数值越大，适用于分布式锁的应用场景-单调递增</p>
</li>
<li><p><strong>临时节点</strong>：临时节点是在会话结束后，自动被删除的，通过这个特性，zk可以实现服务注册与发现的效果。</p>
</li>
<li><p><strong>临时序号节点</strong>：跟持久序号节点相同，适用于临时的分布式锁</p>
</li>
<li><p><strong>Container节点</strong>（3.5.3版本新增）：Container容器节点，当容器中没有任何子节点，该容器节点会被zk定期删除</p>
</li>
<li><p><strong>TTL节点</strong>：可以指定节点的到期时间，到期后被zk定时删除。只能通过系统配置zookeeper.extendedTypeEnablee=true开启</p>
</li>
</ol>
<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>zk的数据是运行在内存中，zk提供了两种持久化机制：</p>
<ul>
<li><p><strong>事务日志</strong>：zk把执行的命令以日志形式保存在dataLogDir指定的路径中的文件中</p>
</li>
<li><p><strong>数据快照</strong>：zk会在一定的时间间隔内做一次内存数据快照，把时刻的内存数据保存在快照文件中</p>
</li>
</ul>
<p>zk通过两种形式的持久化，在恢复时<strong>先恢复快照文件</strong>中的数据到内存中，再用日志文件中的数据做增量恢复，这样恢复的速度更快。</p>
<h2 id="zkCli客户端的使用"><a href="#zkCli客户端的使用" class="headerlink" title="zkCli客户端的使用"></a>zkCli客户端的使用</h2><h3 id="多节点类型创建"><a href="#多节点类型创建" class="headerlink" title="多节点类型创建"></a>多节点类型创建</h3><ul>
<li><p>创建持久节点</p>
<p>create <path> [data] [acl]</p>
</li>
<li><p>创建持久序号节点</p>
<p>create -s <path> [data] [acl]</p>
</li>
<li><p>创建临时节点</p>
<p>create -e <path> [data] [acl]</p>
</li>
<li><p>创建临时序号节点</p>
<p>create -e -s <path> [data] [acl]</p>
</li>
<li><p>创建容器节点</p>
<p>create -c <path> [data] [acl]</p>
</li>
</ul>
<h3 id="查询节点"><a href="#查询节点" class="headerlink" title="查询节点"></a>查询节点</h3><ul>
<li><p>普通查询</p>
<ul>
<li><p>ls [-s -R] <path></p>
<p>-s 详细信息</p>
<p>-R 当前目录和子目录中的所有信息</p>
</li>
</ul>
</li>
<li><p>查询节点相关信息</p>
<ul>
<li>cZxid：创建节点的事务ID</li>
<li>mZxid：修改节点的事务ID</li>
<li>pZxid：添加和删除子节点的事务ID</li>
<li>ctime：节点创建的时间</li>
<li>mtime：节点最近修改的时间</li>
<li>cversion：子节点的version</li>
<li>dataVersion：节点内数据的版本，每更新一次数据，版本会+1</li>
<li>aclVersion：此节点的权限版本</li>
<li>ephemeralOwner：如果当前节点是临时节点，该是是当前节点所有者的session id。如果节点不是临时节点，则该值为零</li>
<li>dataLength：节点内数据的长度</li>
<li>numChildren：该节点的子节点个数</li>
</ul>
</li>
<li><p>查询节点的内容</p>
<ul>
<li><p>get [-s] <path></p>
<p>-s 详细信息</p>
</li>
</ul>
</li>
</ul>
<h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><ul>
<li><p>delete [-v] <path> 删除空节点</p>
<ul>
<li>-v 版本</li>
</ul>
</li>
<li><p>deleteall <path> [-b batch size] 删除包括非空节点</p>
</li>
</ul>
<h3 id="权限设置"><a href="#权限设置" class="headerlink" title="权限设置"></a>权限设置</h3><ul>
<li><p>注册当前会话的账号和密码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addauth digest &lt;账号&gt;:&lt;密码&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建节点并设置权限（指定该节点的用户，以及用户所拥有的权限s）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create /&lt;node&gt; &lt;data&gt; auth:&lt;账号&gt;:&lt;密码&gt;:&lt;权限&gt;</span><br></pre></td></tr></table></figure>
<p>例：<code>create /test-node abcd auth:xiaowang:123456:cdwra</code></p>
</li>
<li><p>在另一个会话中必须先使用账号密码，才能拥有操作节点的权限</p>
</li>
</ul>
<h2 id="使用Curator客户端"><a href="#使用Curator客户端" class="headerlink" title="使用Curator客户端"></a>使用Curator客户端</h2><p>Curator是Netflix公司开源的一套zookeeper客户端框架，Curator是对Zookeeper支持最好的客户端框架。Curator封装了大部分Zookeeper的功能，比如Leader选举、分布式锁等，减少了技术人员在使用Zookeeper时的底层细节开发工作。</p>
<p><strong>引入依赖：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.zookeeper/zookeeper --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.curator/curator-framework --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>创建CuratorProperties</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;curator&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> retryCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> elapsedTimeMs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String connectionString;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> sessionTimeoutMs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> connectionTimeoutMs;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>创建CuratorConfig配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CuratorProperties curatorProperties;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CuratorFramework <span class="title">curatorFramework</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CuratorFramework client = CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(curatorProperties.getConnectionString())</span><br><span class="line">                .connectionTimeoutMs(curatorProperties.getConnectionTimeoutMs())</span><br><span class="line">                .sessionTimeoutMs(curatorProperties.getSessionTimeoutMs())</span><br><span class="line">                .retryPolicy(<span class="keyword">new</span> RetryNTimes(curatorProperties.getRetryCount(), curatorProperties.getElapsedTimeMs()))</span><br><span class="line">                .build();</span><br><span class="line">        client.start();</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>配置application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">curator:</span></span><br><span class="line">  <span class="attr">connection-string:</span> <span class="string">localhost:2181</span></span><br><span class="line">  <span class="attr">retry-count:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">session-timeout-ms:</span> <span class="number">60000</span></span><br><span class="line">  <span class="attr">connection-timeout-ms:</span> <span class="number">4000</span></span><br><span class="line">  <span class="attr">elapsed-time-ms:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><h3 id="锁的种类："><a href="#锁的种类：" class="headerlink" title="锁的种类："></a>锁的种类：</h3><ul>
<li>读锁（读锁共享）：大家都可以读。上锁前提：之前的锁没有写锁</li>
<li>写锁（写锁排他）：只有得到写锁的才能写。上锁前提：之前没有任何锁</li>
</ul>
<h3 id="如何上读锁"><a href="#如何上读锁" class="headerlink" title="如何上读锁"></a>如何上读锁</h3><ul>
<li><p>创建一个临时序号节点，节点的数据是read，表示是读锁</p>
</li>
<li><p>获取当前zk中序号比自己小的所有节点</p>
</li>
<li>判断最小节点是否是读锁<ul>
<li>如果不是读锁的话，则上锁失败，为最小节点设置监听。阻塞等待，zk的watch机制会当最小节点发生变化时通知当前节点，再执行第二步的流程</li>
<li>如果是读锁的话，则上锁成功。</li>
</ul>
</li>
</ul>
<h3 id="如何上写锁"><a href="#如何上写锁" class="headerlink" title="如何上写锁"></a>如何上写锁</h3><ul>
<li>创建一个临时序号节点，节点的数据是write，表示写锁</li>
<li>获取zk中所有的子节点</li>
<li>判断自己是否是最小的节点：<ul>
<li>如果是，则上写锁成功</li>
<li>如果不是，说明前面还有锁，则上锁失败，监听最小节点，如果最小节点有变化，则再执行第二步。</li>
</ul>
</li>
</ul>
<h3 id="羊群效应"><a href="#羊群效应" class="headerlink" title="羊群效应"></a>羊群效应</h3><p>如果用上述的上锁方式，只要有节点发生变化，就会触发其他节点的监听事件，这样对zk的压力非常大，而羊群效应，可以调整成<strong>链式监听</strong>。解决这个问题。</p>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  graph LR
	&#x2F;lock-node --&gt; &#x2F;read0001
	&#x2F;lock-node --&gt; &#x2F;read0002
	&#x2F;lock-node --&gt; &#x2F;read0003
	&#x2F;lock-node --&gt; &#x2F;read0004
	
	&#x2F;read0002 --监听--&gt;&#x2F;read0001
	&#x2F;read0003 --监听--&gt;&#x2F;read0002
	&#x2F;read0004 --监听--&gt;&#x2F;read0003
  </pre></div>
<h3 id="Curator实现读写锁"><a href="#Curator实现读写锁" class="headerlink" title="Curator实现读写锁"></a>Curator实现读写锁</h3><ul>
<li>获取读锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testGetReadLock</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">//读写锁</span></span><br><span class="line">    InterProcessReadWriteLock interProcessReadWriteLock = <span class="keyword">new</span> InterProcessReadWriteLock(client, <span class="string">&quot;/lock1&quot;</span>);</span><br><span class="line">    <span class="comment">//获取读锁对象</span></span><br><span class="line">    InterProcessLock interProcessLock = interProcessReadWriteLock.readLock();</span><br><span class="line">    System.out.println(<span class="string">&quot;等待获取读锁对象中...&quot;</span>);</span><br><span class="line">    <span class="comment">//获取锁</span></span><br><span class="line">    interProcessLock.acquire();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i ++)&#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//释放锁</span></span><br><span class="line">    interProcessLock.release();</span><br><span class="line">    System.out.println(<span class="string">&quot;等待释放锁...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取写锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testGetWriteLock</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">//读写锁</span></span><br><span class="line">    InterProcessReadWriteLock interProcessReadWriteLock = <span class="keyword">new</span> InterProcessReadWriteLock(client, <span class="string">&quot;/lock1&quot;</span>);</span><br><span class="line">    <span class="comment">//获取写锁对象</span></span><br><span class="line">    InterProcessLock interProcessLock = interProcessReadWriteLock.writeLock();</span><br><span class="line">    System.out.println(<span class="string">&quot;等待获取写锁对象中...&quot;</span>);</span><br><span class="line">    <span class="comment">//获取锁</span></span><br><span class="line">    interProcessLock.acquire();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">100</span>; i ++)&#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//释放锁</span></span><br><span class="line">    interProcessLock.release();</span><br><span class="line">    System.out.println(<span class="string">&quot;等待释放锁...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="watch机制"><a href="#watch机制" class="headerlink" title="watch机制"></a>watch机制</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>我们可以把Watch理解成是注册在特定Znode上的<strong>触发器</strong>。当这个Znode发生改变，也就是调用了<strong>create</strong>，<strong>delete</strong>，<strong>setData</strong>方法的时候，将会触发Znode上注册的对应事件，请求Watch的客户端会收到异步通知。</p>
<p>具体交互过程如下：</p>
<ul>
<li><p>客户端调用getData方法，watch参数是true。服务端接到请求，返回节点数据，并且在对应的哈希表里插入被Watch的Znode路径，以及Watcher列表。</p>
</li>
<li><p>当被Watch的Znode已删除，服务端会查找哈希表，找到该Znode对应的所有Watcher，异步通知客户端，并且删除哈希表中对应的key-value。</p>
</li>
</ul>
<h3 id="zkCli客户端使用Watch"><a href="#zkCli客户端使用Watch" class="headerlink" title="zkCli客户端使用Watch"></a>zkCli客户端使用Watch</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create /test date</span><br><span class="line">get -w /test	一次性监听节点</span><br><span class="line">ls -w /test		监听目录，创建和删除子节点会收到通知。但是子节点中新增节点不会被监听到</span><br><span class="line">ls -R -w /test	监听子节点中节点的变化，但内容的变化不会收到通知</span><br></pre></td></tr></table></figure>
<h3 id="Curator客户端使用Watch"><a href="#Curator客户端使用Watch" class="headerlink" title="Curator客户端使用Watch"></a>Curator客户端使用Watch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNodeListener</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    NodeCache nodeCache = <span class="keyword">new</span> NodeCache(curatorFramework,<span class="string">&quot;/curator-node&quot;</span>);</span><br><span class="line">    nodeCache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;&#123;&#125; path nodeChanged: &quot;</span>, <span class="string">&quot;/curator-node&quot;</span>);</span><br><span class="line">            printNodeData();</span><br><span class="line">        &#125;</span><br><span class="line">    )&#125;;</span><br><span class="line">    nodeCache.start();</span><br><span class="line">    <span class="comment">//System.in.read();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printNodeData</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = curatorFramework.getData().forPath(<span class="string">&quot;/curator-node&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;data: &#123;&#125;&quot;</span>, <span class="keyword">new</span> String(bytes));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Zookeeper集群"><a href="#Zookeeper集群" class="headerlink" title="Zookeeper集群"></a>Zookeeper集群</h2><h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><p>zookeeper集群中的节点有三种角色</p>
<ul>
<li>Leader：处理集群的所有事务请求，集群中只有一个Leader</li>
<li>Follower：只能处理读请求，参与Leader选举</li>
<li>Observer：只能处理读请求，提升集群读的性能，但不能参与Leader选举</li>
</ul>
<div class="mermaid-wrap"><pre class="mermaid-src" hidden>
  flowchart LR
	c1[Client1] --&gt; a
	c2[Client2] --&gt; a
	c3[Client3] --&gt; a
	subgraph a[ ]
		Leader --&gt; f1[Follower1]
		Leader --&gt; f2[Follower2]
		Leader --&gt; f3[Follower3]
		Observer
	end
  </pre></div>
<h3 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h3><p>以搭建4个节点为例，搭建伪集群，其中一个节点为Observer</p>
<ul>
<li><p>创建4个节点的myid并设值</p>
<p>在ZK的数据储存目录/tmp/zookeeper中创建以下四个文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">/tmp/zookeeper/zk1#</span><span class="bash"> <span class="built_in">echo</span> 1 &gt; myid</span></span><br><span class="line"><span class="meta">/tmp/zookeeper/zk2#</span><span class="bash"> <span class="built_in">echo</span> 2 &gt; myid</span></span><br><span class="line"><span class="meta">/tmp/zookeeper/zk3#</span><span class="bash"> <span class="built_in">echo</span> 3 &gt; myid</span></span><br><span class="line"><span class="meta">/tmp/zookeeper/zk4#</span><span class="bash"> <span class="built_in">echo</span> 4 &gt; myid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写4个zoo.cfg并修改以下选项</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataDir</span>=<span class="string">/tmp/zookeeper/zk1</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#2001为集群通信端口，3001为集群选举端口，observer（观察者身份）</span></span><br><span class="line"><span class="meta">server.1</span>=<span class="string">192.168.245.128:2001:3001</span></span><br><span class="line"><span class="meta">server.2</span>=<span class="string">192.168.245.128:2002:3002</span></span><br><span class="line"><span class="meta">server.3</span>=<span class="string">192.168.245.128:2003:3003</span></span><br><span class="line"><span class="meta">server.4</span>=<span class="string">192.168.245.128:2004:3004:observer</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>依次启动Zookeeper</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./zkServer.sh start ../conf/zoo1.cfg</span><br><span class="line">./zkServer.sh start ../conf/zoo2.cfg</span><br><span class="line">./zkServer.sh start ../conf/zoo3.cfg</span><br><span class="line">./zkServer.sh start ../conf/zoo4.cfg</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接集群  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zkCli.sh -server 192.168.245.128:2181,192.168.245.128:2182,192.168.245.128:2183</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ZAB协议"><a href="#ZAB协议" class="headerlink" title="ZAB协议"></a>ZAB协议</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Zookeeper作为非常重要的分布式协调组件，需要进行集群部署，集群中会以一主多从的形式进行部署。zookeeper为了保证数据的一致性，使用了ZAB（Zookeeper Atomic Broadcast）协议，这个协议解决了Zookeeper的崩溃恢复和主从数据同步的问题。</p>
<h3 id="集群选举Leader的过程"><a href="#集群选举Leader的过程" class="headerlink" title="集群选举Leader的过程"></a>集群选举Leader的过程</h3><p><strong>集群节点的状态：</strong></p>
<ul>
<li>Looking：选举状态</li>
<li>Following：Follower节点（从节点）所处的状态</li>
<li>Leading：Leader节点（主节点）所处状态</li>
</ul>
<p><img src="https://gitee.com/Wshape1/share-file/raw/master/blog/zookeeper/leader_looking.png" alt="leader选举过程"></p>
<h3 id="崩溃恢复时的Leader选举"><a href="#崩溃恢复时的Leader选举" class="headerlink" title="崩溃恢复时的Leader选举"></a>崩溃恢复时的Leader选举</h3><p>Leader建立完后，Leader周期性地不断向Follower发送心跳（ping命令，没有内容的socket）。当Leader崩溃后，Follower发现socket通道已关闭，于是Follower开始进入到Looking状态，重新回到上一节中的Leader选举状态，此时集群不能对外提供服务。</p>
<h3 id="主从服务器之间的数据同步"><a href="#主从服务器之间的数据同步" class="headerlink" title="主从服务器之间的数据同步"></a>主从服务器之间的数据同步</h3><p><img src="https://gitee.com/Wshape1/share-file/raw/master/blog/zookeeper/lf_copy.png" alt="主从复制"></p>
<h3 id="Zookeeper中的NIO与BIO的应用"><a href="#Zookeeper中的NIO与BIO的应用" class="headerlink" title="Zookeeper中的NIO与BIO的应用"></a>Zookeeper中的NIO与BIO的应用</h3><ul>
<li>NIO<ul>
<li>用于被客户端连接的2181端口，使用的是NIO模式与客户端建立连接</li>
<li>客户端开启Watch时，也使用NIO，等待Zookeeper服务器的回调</li>
</ul>
</li>
<li>BIO<ul>
<li>集群在选举时，多个节点之间的投票通信端口，使用BIO进行通信</li>
</ul>
</li>
</ul>
<h2 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h2><h3 id="CAP理论-1"><a href="#CAP理论-1" class="headerlink" title="CAP理论"></a>CAP理论</h3><p>CAP理论为：一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和区分容错性（Partition tolerance）这三项中的两项。</p>
<ul>
<li><strong>—致性(Consistency)</strong></li>
</ul>
<p>一致性指”all nodespsee the same data at the same time”，即更新操作成功并返回客户端完成后，所有节点在同一时间的数据完全一致。</p>
<ul>
<li><strong>可用性(Availability)</strong></li>
</ul>
<p>可用性指”Reads and writes always succeed”，即服务一直可用，而且是正常响应时间。</p>
<ul>
<li><strong>分区容错性(Partition tolerance)</strong></li>
</ul>
<p>分区容错性指”the system continues to operate despite arbitrary message loss or failure of part of the system”，即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性或可用性的服务。——避免单点故障，就要进行冗余部署，冗余部署相当于是服务的分区，这样的分区就具备了容错性。</p>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><p>核心思想是即使无法做到强一致性(Strong Consistency，CAP的一致性就是强一致性)，但应用可以采用适合的方式达到最终一致性(Eventual Consitency) 。</p>
<ul>
<li><strong>基本可用(Basically Available)</strong></li>
</ul>
<p>基本可用是指分布式系统在出现故障的时候，允许损失部分可用性，即保证核心可用。</p>
<p>电商大促时，为了应对访问量激增，部分用户可能会被引导到降级页面，服务层也可能只提供降级服务。这就是损失部分可用性的体现。</p>
<ul>
<li><strong>软状态(Soft State)</strong></li>
</ul>
<p>软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据至少会有三个副本，允许不同节点间副本同步的延时就是软状态的体现。mysql replication的异步复制也是一种体现。</p>
<ul>
<li><strong>最终一致性(Eventual Consistency)</strong></li>
</ul>
<p>最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的—种特殊情况。</p>
<h3 id="Zookeeper追求的一致性"><a href="#Zookeeper追求的一致性" class="headerlink" title="Zookeeper追求的一致性"></a>Zookeeper追求的一致性</h3><p>Zookeeper在数据同步时，追求的并不是强一致性，而是顺序一致性（事务id的单调递增）</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Wshape1</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wshape1.github.io/2023/02/21/zookeeper-note/">https://wshape1.github.io/2023/02/21/zookeeper-note/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wshape1.github.io" target="_blank">Wshape1's Blogs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/Zookeeper/">Zookeeper</a></div><div class="post_share"><div class="social-share" data-image="https://zookeeper.apache.org/images/zookeeper_small.gif" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/01/30/redis-note/"><img class="next-cover" src="https://patchwiki.biligame.com/images/mc/0/03/3fv74f4eqddkqdp0oi65jzfkf5ghq0r.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/01/24/linux-note/" title="Linux学习笔记"><img class="cover" src="https://static.wikia.nocookie.net/mccreator/images/1/16/For_minecraft_ideas_wiki_penguin.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-24</div><div class="title">Linux学习笔记</div></div></a></div><div><a href="/2023/01/30/redis-note/" title="Redis学习笔记"><img class="cover" src="https://patchwiki.biligame.com/images/mc/0/03/3fv74f4eqddkqdp0oi65jzfkf5ghq0r.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-30</div><div class="title">Redis学习笔记</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Wshape1</div><div class="author-info__description">美好都会如期而至的。</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">6</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Wshape1" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:Wshape1@126.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">ohHHHHHHH~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zookeeper"><span class="toc-number">1.</span> <span class="toc-text">Zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.</span> <span class="toc-text">安装和配置启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80"><span class="toc-number">1.1.1.</span> <span class="toc-text">下载地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Zookeeper"><span class="toc-number">1.1.3.</span> <span class="toc-text">启动Zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows%E4%B8%8B%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">Windows下启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux%E4%B8%8B%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">Linux下启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">内部数据模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Znode%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">Znode的组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Znode%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">Znode的类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">数据持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zkCli%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.</span> <span class="toc-text">zkCli客户端的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B%E5%88%9B%E5%BB%BA"><span class="toc-number">1.4.1.</span> <span class="toc-text">多节点类型创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%8A%82%E7%82%B9"><span class="toc-number">1.4.2.</span> <span class="toc-text">查询节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="toc-number">1.4.3.</span> <span class="toc-text">删除节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.4.4.</span> <span class="toc-text">权限设置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Curator%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.5.</span> <span class="toc-text">使用Curator客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.6.</span> <span class="toc-text">分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E7%A7%8D%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.6.1.</span> <span class="toc-text">锁的种类：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%B8%8A%E8%AF%BB%E9%94%81"><span class="toc-number">1.6.2.</span> <span class="toc-text">如何上读锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%B8%8A%E5%86%99%E9%94%81"><span class="toc-number">1.6.3.</span> <span class="toc-text">如何上写锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BE%8A%E7%BE%A4%E6%95%88%E5%BA%94"><span class="toc-number">1.6.4.</span> <span class="toc-text">羊群效应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-number">1.6.5.</span> <span class="toc-text">Curator实现读写锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#watch%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">watch机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zkCli%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8Watch"><span class="toc-number">1.7.2.</span> <span class="toc-text">zkCli客户端使用Watch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Curator%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8Watch"><span class="toc-number">1.7.3.</span> <span class="toc-text">Curator客户端使用Watch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper%E9%9B%86%E7%BE%A4"><span class="toc-number">1.8.</span> <span class="toc-text">Zookeeper集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="toc-number">1.8.1.</span> <span class="toc-text">集群角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.8.2.</span> <span class="toc-text">集群搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZAB%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.9.</span> <span class="toc-text">ZAB协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.9.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%80%89%E4%B8%BELeader%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.9.2.</span> <span class="toc-text">集群选举Leader的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B4%A9%E6%BA%83%E6%81%A2%E5%A4%8D%E6%97%B6%E7%9A%84Leader%E9%80%89%E4%B8%BE"><span class="toc-number">1.9.3.</span> <span class="toc-text">崩溃恢复时的Leader选举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">1.9.4.</span> <span class="toc-text">主从服务器之间的数据同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zookeeper%E4%B8%AD%E7%9A%84NIO%E4%B8%8EBIO%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.9.5.</span> <span class="toc-text">Zookeeper中的NIO与BIO的应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP%E7%90%86%E8%AE%BA"><span class="toc-number">1.10.</span> <span class="toc-text">CAP理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAP%E7%90%86%E8%AE%BA-1"><span class="toc-number">1.10.1.</span> <span class="toc-text">CAP理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BASE%E7%90%86%E8%AE%BA"><span class="toc-number">1.10.2.</span> <span class="toc-text">BASE理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zookeeper%E8%BF%BD%E6%B1%82%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.10.3.</span> <span class="toc-text">Zookeeper追求的一致性</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/21/zookeeper-note/" title="Zookeeper学习笔记"><img src="https://zookeeper.apache.org/images/zookeeper_small.gif" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Zookeeper学习笔记"/></a><div class="content"><a class="title" href="/2023/02/21/zookeeper-note/" title="Zookeeper学习笔记">Zookeeper学习笔记</a><time datetime="2023-02-21T13:50:00.000Z" title="发表于 2023-02-21 21:50:00">2023-02-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/30/redis-note/" title="Redis学习笔记"><img src="https://patchwiki.biligame.com/images/mc/0/03/3fv74f4eqddkqdp0oi65jzfkf5ghq0r.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis学习笔记"/></a><div class="content"><a class="title" href="/2023/01/30/redis-note/" title="Redis学习笔记">Redis学习笔记</a><time datetime="2023-01-30T05:22:02.000Z" title="发表于 2023-01-30 13:22:02">2023-01-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/24/linux-note/" title="Linux学习笔记"><img src="https://static.wikia.nocookie.net/mccreator/images/1/16/For_minecraft_ideas_wiki_penguin.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux学习笔记"/></a><div class="content"><a class="title" href="/2023/01/24/linux-note/" title="Linux学习笔记">Linux学习笔记</a><time datetime="2023-01-24T03:21:02.000Z" title="发表于 2023-01-24 11:21:02">2023-01-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/15/fast_power/" title="快速幂算法(例:a^b mod p)"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="快速幂算法(例:a^b mod p)"/></a><div class="content"><a class="title" href="/2022/07/15/fast_power/" title="快速幂算法(例:a^b mod p)">快速幂算法(例:a^b mod p)</a><time datetime="2022-07-15T14:32:18.000Z" title="发表于 2022-07-15 22:32:18">2022-07-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/23/minimum_spanning_tree/" title="最小生成树(Minimum Spanning Tree)"><img src="https://static.wikia.nocookie.net/minecraft_zh_gamepedia/images/a/a8/Oak_Tree.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="最小生成树(Minimum Spanning Tree)"/></a><div class="content"><a class="title" href="/2022/02/23/minimum_spanning_tree/" title="最小生成树(Minimum Spanning Tree)">最小生成树(Minimum Spanning Tree)</a><time datetime="2022-02-23T08:12:09.000Z" title="发表于 2022-02-23 16:12:09">2022-02-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cache.yisu.com/upload/information/20220118/481/183040.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By Wshape1</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'JUaE6LSYa5q23srllxlbIS2i-MdYXbMMI',
      appKey: 'kXOeN42QEGu5BnukGYgsEuqF',
      avatar: 'monsterid',
      serverURLs: 'https://juae6lsy.api.lncldglobal.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>